<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Linux - AD Auth with SSSD</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://next-hop-self.com/index.xml title=next-hop-self><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux - AD Auth with SSSD"><meta name=twitter:description content="Install necessary packages: sudo apt install sssd-ad sssd-tools realmd adcli
Join the domain: sudo realm join <domain name>
Enable home directories with pam: sudo pam-auth-update --enable mkhomedir
Configure SSSD. Note: the line &ldquo;ldap_user_ssh_public_key = sshPublicKey&rdquo; becomes important in a later step, but included for completeness of sssd.conf
# /etc/sssd/sssd.conf [sssd] domains = <domain name> config_file_version = 2 services = nss, pam, sudo [domain/<domain name>] default_shell = /bin/bash krb5_store_password_if_offline = True cache_credentials = True krb5_realm = <domain name> realmd_tags = manages-system joined-with-adcli id_provider = ad fallback_homedir = /home/%u@%d ad_domain = <domain name> use_fully_qualified_names = True ldap_id_mapping = True access_provider = ad ldap_user_ssh_public_key = sshPublicKey [sudo] Then, restart sssd and test: sudo systemctl sssd restart"><link rel=stylesheet href=https://next-hop-self.com/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://next-hop-self.com/css/custom.css><link rel=stylesheet href=https://next-hop-self.com/css/syntax.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById("dark-mode-theme"),storedTheme=localStorage.getItem("dark-mode-storage");storedTheme==="dark"?darkTheme.disabled=!1:storedTheme==="light"&&(darkTheme.disabled=!0)</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script>
<script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.109.0"></head><body><header><nav class=navbar><div class=nav><a href=https://next-hop-self.com/ class=nav-logo><img src=https://next-hop-self.com/images/logo-pxm.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories id=Category><em class="fas fa-folder-open fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Linux - AD Auth with SSSD</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><ol><li><p>Install necessary packages: <code>sudo apt install sssd-ad sssd-tools realmd adcli</code></p></li><li><p>Join the domain: <code>sudo realm join &lt;domain name></code></p></li><li><p>Enable home directories with pam: <code>sudo pam-auth-update --enable mkhomedir</code></p></li><li><p>Configure SSSD. Note: the line &ldquo;ldap_user_ssh_public_key = sshPublicKey&rdquo; becomes important in a later step, but included for completeness of sssd.conf</p><pre tabindex=0><code># /etc/sssd/sssd.conf
[sssd]
domains = &lt;domain name&gt;
config_file_version = 2
services = nss, pam, sudo

[domain/&lt;domain name&gt;]
default_shell = /bin/bash
krb5_store_password_if_offline = True
cache_credentials = True
krb5_realm = &lt;domain name&gt;
realmd_tags = manages-system joined-with-adcli
id_provider = ad
fallback_homedir = /home/%u@%d
ad_domain = &lt;domain name&gt;
use_fully_qualified_names = True
ldap_id_mapping = True
access_provider = ad
ldap_user_ssh_public_key = sshPublicKey


[sudo]
</code></pre><p>Then, restart sssd and test: <code>sudo systemctl sssd restart</code></p></li><li><p>Configure sudo to allow sudo based on AD group:</p><pre tabindex=0><code>visudo
%linuxadmins@&lt;domain name&gt; ALL=(ALL) NOPASSWD:ALL
</code></pre></li><li><p>Store SSH Keys in AD. This is well explained by <a href=https://blog.laslabs.com/2016/08/storing-ssh-keys-in-active-directory/>this blog post</a> and does need to be rehashed here. The value mapping I used is sshPublicKey, and this config line in sssd.conf is what you need:</p><pre tabindex=0><code>ldap_user_ssh_public_key = sshPublicKey
</code></pre><p>Also, you&rsquo;ll need the following in <code>/etc/sshd/sshd_config</code>:</p><pre tabindex=0><code>AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys
AuthorizedKeysCommandUser root
</code></pre><p>Restart SSH server: <code>sudo systemctl sshd restart</code>. You can also test authorized keys are being pulled correctly with the following command:</p><pre tabindex=0><code>sudo /usr/bin/sss_ssh_authorizedkeys &lt;username&gt;
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDex2RUYI75nlIPRyx1CPUVJrNE58qRVGJoUf+/Oq2xWBxAKjoksXYdyvCvNBijr56SBj7Zhze+LWUynlBD+Lp1afPtKft0qeltm7N7E9PKaIKUClxuSMnNJ/+Hr28k8+vFQfY/sKHzUstbykBh575IVQGwvXsEIsD70zKjkyHEGkytsZqDk+N35gSC68mya86+CaXvWCMn3njNmdeiYoUfQbOjdVCtfd7oB7mCZOfO9MIPFIEqiyHkXVePuBd0uOO9DjIO+WhPNeMHK9B7loOgA5foeGMeFS/7Hrp+FsX7zOeJcOqzBgogRhvEx63aEFziH+/dEfJlvI/OBVdEyDdOyIl7vAsi3rrB8uHN40vrFcfcOgeKHys3LwMu+rib75unvq6l0dGQlytz5ZITOKsmprXvc= 
</code></pre><p>You may also need to clear the SSSD cache during the initial setup, <code>sudo sss_cache -E</code></p></li></ol><div class=blog-tags><a href=https://next-hop-self.com/tags/linux/>linux</a>&nbsp;
<a href=https://next-hop-self.com/tags/active-directory/>active directory</a>&nbsp;</div></article></div><footer><div class=social-icons><a href=https://www.linkedin.com/in/gossew/ name=LinkedIn><em class="fab fa-linkedin"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://github.com/gosse name=GitHub><em class="fab fa-github"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://twitter.com/gossewaa name=Twitter><em class="fab fa-twitter"></em></a></div><div class=container><p class="credits copyright"><a href=https://next-hop-self.com/about>Gary Ossewaarde</a>
&nbsp;&copy;
2022
&nbsp;/&nbsp;
<a href=https://next-hop-self.com/>next-hop-self</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by"><a href=https://gohugo.io>Hugo</a>&nbsp;
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>