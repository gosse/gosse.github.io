<!doctype html><html lang=en-us><head><meta charset=utf-8><title>FTD Authentication with Azure MFA</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://next-hop-self.com/index.xml title=next-hop-self><meta name=twitter:card content="summary"><meta name=twitter:title content="FTD Authentication with Azure MFA"><meta name=twitter:description content="I recently configured Azure MFA to authenticate AnyConnect users connecting to a FTD firewall. This required some odd workarounds."><link rel=stylesheet href=https://next-hop-self.com/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://next-hop-self.com/css/custom.css><link rel=stylesheet href=https://next-hop-self.com/css/syntax.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById("dark-mode-theme"),storedTheme=localStorage.getItem("dark-mode-storage");storedTheme==="dark"?darkTheme.disabled=!1:storedTheme==="light"&&(darkTheme.disabled=!0)</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script>
<script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.101.0"></head><body><header><nav class=navbar><div class=nav><a href=https://next-hop-self.com/ class=nav-logo><img src=https://next-hop-self.com/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories id=Category><em class="fas fa-folder-open fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>FTD Authentication with Azure MFA</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>I recently configured Azure MFA to authenticate AnyConnect users connecting to a FTD firewall. This required some odd workarounds.</p><p><strong>Problems to work around</strong></p><ol><li>FTD cannot do SAML, must use RADIUS for AnyConnect AAA (note: later versoins of FTD are SAML capable)</li><li>Microsoft NPS with Azure MFA extension must be used for RADIUS Integration to Azure MFA</li><li>Microsoft NPS has a limited number of attributes it can filter incoming RADIUS requests on</li><li>Customer has a need to only allow certain AD groups access to certain tunnel groups</li></ol><p><strong>Authentication Flow</strong></p><ol><li>Firewall sends Access-Request to ISE</li><li>ISE adds RADIUS:NAS Identifier attribute to Access-Request based on CVPN3000/ASA/PIX7x-Tunnel-Group-Name</li><li>NPS filters incoming requests based on NAS Identifier to appropriately authenticate different tunnel groups and does primary authentication against AD.</li><li>NPS requests secondary authentication from Azure MFA</li><li>Azure MFA completes MFA with user, based on the user’s default MFA method. There is no way to select this during the authentication sequence.</li><li>NPS sends result back to ISE</li><li>ISE proxies result back to FTD</li></ol><p><strong>Authentication Diagram</strong></p><p><img src=../ftd-azuremfa.svg alt="Authentication Diagram"></p><p><strong>Identity Services Engine (ISE) Configuration</strong></p><ul><li><p>External RADIUS Servers – define your NPS server(s) and shared secret here</p></li><li><p>RADIUS Server Sequence</p><ul><li>Create a sequence per tunnel group that needs to be differentiated</li><li>In the Advanced Attribute Settings tab, add the NAS Identifier attribute</li></ul></li><li><p>Policy Sets</p><ul><li>Create one policy set per tunnel group</li><li>Conditions: NAS-Port-Type Virtual AND CVPN3000/ASA/PIX7x-Tunnel-Group-Name = MyGroupName</li><li>Server Sequence: proxy sequence created above</li></ul></li></ul><p><strong>Network Policy Server (NPS) Configuration</strong></p><ul><li>Install Azure MFA extension and link to Azure AD – <a href=https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-nps-extension%3E>https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-nps-extension></a><ul><li>Protip: use a new NPS server. Once you install the extension, all requests authenticated locally will be subject to MFA</li></ul></li><li>RADIUS Clients<ul><li>In the NPS console, configure your ISE servers as RADIUS clients, using the same shared secret as above.</li><li>Vendor – RADIUS Standard</li></ul></li><li>Network Policies<ul><li>Create one per tunnel group name</li><li>Type of network access server – Unspecified</li><li>Conditions<ul><li>NAS Identifier – the identifier ISE added</li><li>User Groups – group you want to filter on</li></ul></li><li>NAS-Port-Type Virtual</li><li>Authentication Methods – I have them all enabled, including PEAP and EAP-MSCHAPv2 You minimally need PAP, but I have lots of logs that say “Custom” for the Authentication Type.</li><li>Note: The Microsoft documentation says: <em>“<strong>PAP</strong> supports all the authentication methods of Azure MFA in the cloud: phone call, one-way text message, mobile app notification, OATH hardware tokens, and mobile app verification code. *CHAPV2 and EAP* support phone call and mobile app notification.”</em></li></ul></li></ul><p><strong>Firepower Threat Defense (FTD) Configuration</strong></p><ul><li>Configure ISE as your RADIUS servers for AnyConnect AAA.</li><li>Set the timeout to 60 seconds or longer—if users are waiting for an SMS, phone call, push notification, etc., you want to give them enough time to do it.</li></ul><p><strong>User Experience</strong></p><ul><li>Users will put in their username and password at the AnyConnect client</li><li>If their preferred option (set at <a href=https://account.activedirectory.windowsazure.com/Proofup.aspx>https://account.activedirectory.windowsazure.com/Proofup.aspx</a>) uses a code (verification code form app or text message), they will see a pop-up after their first authentication.</li><li>If their preferred option is a voice call or push notification, the authentication will wait until the verification is complete before granting access. Make sure all timeouts in the chain are long enough to support this.</li></ul><p><strong>Troubleshooting</strong></p><p>The NPS logs are a pain to use for troubleshooting. I wrote a quick python script to help parse the logs. You can find it here: <a href=https://github.com/gosse/interpret-nps-logs>https://github.com/gosse/interpret-nps-logs</a>.</p><div class=blog-tags><a href=https://next-hop-self.com/tags/azure/>azure</a>&nbsp;
<a href=https://next-hop-self.com/tags/cisco/>cisco</a>&nbsp;
<a href=https://next-hop-self.com/tags/ftd/>ftd</a>&nbsp;
<a href=https://next-hop-self.com/tags/networking/>networking</a>&nbsp;
<a href=https://next-hop-self.com/tags/security/>security</a>&nbsp;</div></article></div><footer><div class=social-icons><a href=https://www.linkedin.com/in/gossew/ name=LinkedIn><em class="fab fa-linkedin"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://github.com/gosse name=GitHub><em class="fab fa-github"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://twitter.com/gossewaa name=Twitter><em class="fab fa-twitter"></em></a></div><div class=container><p class="credits copyright"><a href=https://next-hop-self.com/about>Gary Ossewaarde</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://next-hop-self.com/>next-hop-self</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by"><a href=https://gohugo.io>Hugo</a>&nbsp;
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>