<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Tailscale on Cisco ISR4k</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://gosse.github.io/index.xml title=next-hop-self><meta name=twitter:card content="summary"><meta name=twitter:title content="Tailscale on Cisco ISR4k"><meta name=twitter:description content="I absolutely love using tailscale. It uses a great new protocol, wireguard, but makes it easy to configure and use. I’ve used it as a VPN service for over a year now, but have always wanted to connected to devices that are not tailscale capable.
My home router is a Cisco ISR4321. These are routers capable of running IOx, which allows you to run containers or even full-blown virtual machines on the router itself."><link rel=stylesheet href=https://gosse.github.io/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById("dark-mode-theme"),storedTheme=localStorage.getItem("dark-mode-storage");storedTheme==="dark"?darkTheme.disabled=!1:storedTheme==="light"&&(darkTheme.disabled=!0)</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script>
<script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.101.0"></head><body><header><nav class=navbar><div class=nav><a href=https://gosse.github.io/ class=nav-logo><img src=https://gosse.github.io/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories id=Category><em class="fas fa-folder-open fa-lg"></em></a></li><li><a href=/archives id=Archives><em class="fas fa-archive fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Tailscale on Cisco ISR4k</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>I absolutely love using <a href=https://tailscale.com/>tailscale</a>. It uses a great new protocol, <a href=https://www.wireguard.com/>wireguard</a>, but makes it easy to configure and use. I’ve used it as a VPN service for over a year now, but have always wanted to connected to devices that are not tailscale capable.</p><p>My home router is a Cisco ISR4321. These are routers capable of running IOx, which allows you to run containers or even full-blown virtual machines on the router itself. The easiest way to get started with this is using <a href=https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/prog/configuration/166/b_166_programmability_cg/guest_shell.html>guestshell</a>, which comes packaged with IOS-XE. I did not try to run tailscale in guestshell, I wanted to run a separate virtual machine.</p><h3 id=build-tailscale-router-vm>Build Tailscale Router VM</h3><p>I built my tailscale router VM on Alpine Linux. The steps were pretty easy,</p><ul><li>Install Alpine to disk</li><li>Enable community repos</li><li>Install qemu-guest-agent and tailscale, <code>apk add qemu-guest-agent tailscale</code></li><li>Enable IP forwarding, add <code>net.ipv4.ip_forward = 1</code> and <code>net.ipv6.conf.all.forwarding = 1</code> to /etc/sysctl.conf</li><li>Shutdown the VM</li></ul><p>At this point, you need the disk image to be qcow2. I was using VMware to build my VM, so I had to convert it, <code>qemu-img convert -c -O qcow2 /tmp/alpinetailscale100.vmdk /tmp/alpinetailscale100.qcow2</code></p><h3 id=create-the-iox-package>Create the IOx Package</h3><p>You need the ioxclient tool for this part. This can be downloaded from <a href=https://developer.cisco.com/docs/iox/#!iox-resource-downloads/downloads>DevNet here</a>. I opted to use the SDE virtual machine, which has all the necessary tools already installed. I copied my qcow2 to the VM and created my packages descriptor file, <strong>package.yaml</strong></p><pre tabindex=0><code>&lt;pre class=&#34;&#34;&gt;ioxsde@ioxsde:~$ cat package.yaml
descriptor-schema-version: &#34;2.4&#34;

info:
  name: tailscale
  description: &#34;Alpine Linux with tailscale installed&#34;
  version: &#34;1.0&#34;
  author-link: &#34;http://next-hop-self.com&#34;
  author-name: &#34;Gary Ossewaarde&#34;

app:
  type: vm
  cpuarch: x86_64
  resources:
    profile: custom
    cpu: 200
    memory: 1024
    disk: 2

    network:
      -
        interface-name: eth0
  # Specify runtime and startup
  startup:
    disks:
      -
        target-dev: &#34;hdc&#34;
        file: &#34;alpinetailscale100.qcow2&#34;

    qemu-guest-agent: True
</code></pre><p>Once you have this to your liking, you can create the package file with: <code>ioxclient package --name tailscale101 .</code>. This will create a file, tailscale101.tar in the folder you run the command in. Copy this file to your router: <code>scp tailscale101.tar admin@192.168.10.1:bootflash:tailscale101.tar</code></p><h3 id=installactive-app-on-router>Install/Active App on Router</h3><p>First, you need to configure your internal networking if you haven’t yet. The IOx apps use VirtualPortGroup interfaces to connect to the IOS part of the router. My interface configuration looks like this:</p><pre tabindex=0><code>&lt;pre class=&#34;&#34;&gt;interface VirtualPortGroup0
ip address 10.0.0.1 255.255.255.0
ip nat inside
</code></pre><pre tabindex=0><code>&lt;pre class=&#34;&#34;&gt;app-hosting appid tailscale
 app-vnic gateway0 virtualportgroup 0 guest-interface 0
ip dhcp pool app-hosting
 network 10.0.0.0 255.255.255.0
 default-router 10.0.0.1
 dns-server 1.1.1.1
</code></pre><pre tabindex=0><code>&lt;pre class=&#34;&#34;&gt;isr4k#app-hosting install appid tailscale package bootflash:tailscale101.tar
isr4k#app-hosting activate appid helloworld_app
isr4k#app-hosting start appid helloworld_app
isr4k#app-hosting connect appid helloworld_app console
</code></pre><p>At this point, you should be in the shell of your virtual machine.</p><pre tabindex=0><code>&lt;pre class=&#34;&#34;&gt;localhost:~# ip addr
link/ether 52:54:dd:47:76:e8 brd ff:ff:ff:ff:ff:ff
inet 10.0.0.3/24 scope global eth0
valid_lft forever preferred_lft forever
inet6 fe80::5054:ddff:fe47:76e8/64 scope link
valid_lft forever preferred_lft forever
</code></pre><p>Now that the VM is running, just a few things are left. First, bring up tailscale and add your routes. In the VM, <code>tailscale up --advertise-routes=192.168.10.0/24</code>. Once you run this command, you will need to copy and paste the tailscale URL into a browser and authenticate. Once this is activate, you will need to enable the routes in the tailscale admin portal. See <a href=https://tailscale.com/kb/1019/subnets/>these docs</a> for more information.</p><p>Clients on Windows, macOS, iOS, and Android will automatically pick up your new subnet routes. For Linux, I had to tell also run the command <code>tailscale up --accept-routes.</code></p><h3 id=additional-resources>Additional Resources</h3><p>I had to combine information from the following two DevNet guides to work out what I needed.</p><ul><li><a href=https://developer.cisco.com/docs/iox/#!tutorial-build-sample-vm-type-iox-app/tutorial-build-sample-vm-type-iox-app>Tutorial: Build sample LXC type IOx app using Docker toolchain</a></li><li><a href=https://developer.cisco.com/docs/iox/#!lxc-workflow/build-docker-image>Tutorial: Build sample VM type IOx app</a></li></ul></article></div><footer><div class=social-icons><a href=https://www.linkedin.com/in/gossew/ name=LinkedIn><em class="fab fa-linkedin"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://github.com/gosse name=GitHub><em class="fab fa-github"></em></a>
&nbsp;&ndash;&nbsp;
<a href=https://twitter.com/gossewaa name=Twitter><em class="fab fa-twitter"></em></a></div><div class=container><p class="credits copyright"><a href=https://gosse.github.io/about>Gary Ossewaarde</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://gosse.github.io/>next-hop-self</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by"><a href=https://gohugo.io>Hugo</a>&nbsp;
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>